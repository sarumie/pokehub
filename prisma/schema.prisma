generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String            @id @default(uuid())
  username         String            @unique
  password         String
  email            String            @unique
  profilePicture   String?
  fullName         String?
  shipDetails      AddressDetails?   @relation(fields: [idAddressDetails], references: [id])
  idAddressDetails String?           @unique
  listings         Listing[]         @relation("SellerListings")
  cartItems        Cart[]
  purchases        PurchaseHistory[] @relation("BuyerPurchases")
  ratingsGiven     Rating[]          @relation("UserRatings")
  ratingsReceived  Rating[]          @relation("SellerRatings")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model AddressDetails {
  id         String @id @default(uuid())
  name       String
  receiver   String
  province   String
  city       String
  postalCode String
  address    String
  user       User?
}

model Listing {
  id          String   @id @default(uuid())
  seller      User     @relation("SellerListings", fields: [idSeller], references: [id])
  idSeller    String
  pictUrl     String
  name        String
  price       Int
  description String   @db.Text
  stock       Int
  seenCount   Int      @default(0)
  carts       Cart[]
  ratings     Rating[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Expedition {
  id               String            @id @default(uuid())
  name             String
  paymentTimestamp Int
  logo             String
  purchases        PurchaseHistory[]
}

model PurchaseHistory {
  id               String     @id @default(uuid())
  buyer            User       @relation("BuyerPurchases", fields: [idBuyer], references: [id])
  idBuyer          String
  paymentTimestamp DateTime
  totalPrice       Int
  expedition       Expedition @relation(fields: [idExpedition], references: [id])
  idExpedition     String
  stock            Int
  rating           Rating?
  createdAt        DateTime   @default(now())
}

model Cart {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [idUser], references: [id])
  idUser     String
  listing    Listing  @relation(fields: [idListings], references: [id])
  idListings String
  quantity   Int      @default(1)
  totalPrice Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([idUser, idListings])
}

model Rating {
  id        String          @id @default(uuid())
  order     PurchaseHistory @relation(fields: [orderId], references: [id])
  orderId   String          @unique
  user      User            @relation("UserRatings", fields: [userId], references: [id])
  userId    String
  listing   Listing         @relation(fields: [listingId], references: [id])
  listingId String
  seller    User            @relation("SellerRatings", fields: [sellerId], references: [id])
  sellerId  String
  score     Int
  review    String?         @db.Text
  createdAt DateTime        @default(now())

  @@unique([userId, listingId])
}
